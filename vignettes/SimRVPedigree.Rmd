---
title: "SimRVPedigree"
author: "Christina Nieuwoudt, Jinko Graham"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{SimRVPedigree}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type="text/css">

body{ /* Normal  */
   font-size: 20px;
}
</style>

# Table of contents
1. [Introduction](#introduction)
2. [Individual and Pedigree Specific Assumptions](#PedLevel)
3. [Study Design/Ascertainment Scheme Features](#StudyLevel)
4. [The `sim_RVpedigree` Function](#simRVped)
5. [Example Application to Family-Based Study](#Example)
6. [Parallel Processing Example](#ParProcExample)


# Introduction <a name="introduction"></a>
Family-based studies designed to identify genetic susceptibility factors associated with rare diseases have received significant consideration in recent years.  Due to the rarity of the diseases under consideration, in some cases, garnering a suitable number of families for analysis could require decades of continued collaboration between researchers and clinicians.  Understandably, due to the nature of these studies, they are inherently difficult and sometimes infeasible to replicate.  The `SimRVPedigree` package aims to address this problem by providing a platform to randomly simulate pedigrees similar to those ascertained  for family-based studies to contain multiple relatives affected with a rare disease.

The distinguishing feature of the `SimRVPedigree` packages is that it aims to accurately mimic the process of family development, while allowing users to incorporate multiple facets of a particular acsertainment scheme.  To illustrate and fully explain these features, in the next two sections, we will first discuss assumptions governing the process of pedigree simulation, followed by a full exposition of the study design features available to users.  Later we provide an example, which illustrates an application of `SimRVPedigree` to simulate pedigrees for a specific family-based study.

#Individual and Pedigree Specific Assumptions <a name="PedLevel"></a>
1. Given a sample of pedigrees we allow for the possibility that different families may segregate different rare variants, but make the assumption that within a family genetic cases are due to a shared rare variant that increases disease susceptibility.

2. We assume that the variant is rare enough that it has been introduced by at most one founder.  We begin the simulation of the pedigree with this founder, and transmit the rare variant from parent to offspring according to Mendel's laws.

3. We assume that the age-specific hazard for disease onset follows a Cox proportional hazards model.  Under this model, individuals who have NOT inheritied the rare variant (i.e. sporadic cases) experience disease onset according to the baseline (or population) disease onset hazard.  On the other hand, individuals who have inherited the rare variant (i.e. genetic cases),  are assumed to have an increased relative risk of diesease onset.  The user is expected to supply the baseline disease onset hazard, as well as the relative risk of disease onset for genetic cases.  

4. We assume that unaffected individuals experience death according to the age-specific death hazard of the unaffected population, which is provided by the user.  If the disease of interest is rare enough, the user may substitute the 
population age-specific death hazard in place of the unaffected age-specific death hazard.  We assume that affected individuals experience death according to the age-specific death hazard of the affected population, also provided by the user.  

5. We do not model disease remission, nor do we model second onset events.  That is, we impose the restriction that individuals who experience disease onset may only do so once.  Furthermore, after onset has occured the affected death hazard is always used to simulate the death event, i.e. we do not switch back to using the unaffected death hazard after a specified number of years.

[REMOVE AFTER DISCUSSING WITH JINKO]  NOTE: Our assumption that genetic cases share the same relative risk parameter across families is not imposed upon the user.  Since the top level function only simulates a single pedigree (we decided to do this so that users could efficiently implement parallel processing) the user could choose to simulate a study sample containing families with different relative risks.  However, I worked this assumption into the example so that users might take the hint ;)

#Study Design/Ascertainment Scheme Features <a name="StudyLevel"></a>
The `sim_RVpedigree` function is used to randomly simulate families likely to be ascertained under a particular study design or ascertainment scheme.  The study design features available to the user are as follows:

1. `num_affected`: the minimum number of relatives affected with the disease  of interest in each pedigree. 

2. `ascertain_span`: The ascertaiment span, in years, in which the family-based study ascertains families for analysis.  We require that the proband, i.e. the affected family member who enlists the familiy for analysis, experienced disease onset during the ascertainment period.  Additionally, when `num_affected` = $n$ affecteds are requested, we require that at the time of ascertainment the proband is at least the $n^{th}$ affected.  For example, suppose that we would like to mimic a family-based study that requires at least 3 affecteds per family.  Presumably, the family would be asertained for study when the proband, upon speaking to the clinician, informs the clinician that he or she is aware of at least 2 family members who are also affected by the disease of interest.  We also require that this condition is met when simulating families with incomplete ascertainment, discussed next.

4. `recall_probs`: the proband's relative recall probabilities, $p = (p_1, p_2, ..., p_n)$ where $$\rho_i = \left\{ \begin{array}{ll}
                \text{proband recall probability for a relative of degree } i & \text{for } i < n;\\
                \text{proband recall probability for a relative of degree $n$ or greater} & \text{for } i = n.\end{array} \right.$$
This option is included to allow researchers to model the ascertainment bias that occurs when individuals either cannot provide a complete family history or they explicity request that particular family members not be contacted.  To simulate fully ascertained families simply specify `recall_probs = c(1)` so that the proband's recall probability of all relatives is 1.  If `recall_probs` is unspecified, the default values of 4*kinship coeffient between the proband and his or her relatives is assumed, which has the effect of retaining all first degree relatives with probability 1, retaining all second degree relatives with probability 0.5, retaining all third degree relatives with probability 0.25, etc.

3. `stop_year`: the stop year represents either: the year that the study ends or the last full year that data has been collected.  All events that occur after the stop year are censored.


#The `sim_RVpedigree` Function <a name="simRVped"></a>
Simulation of pedigrees likely to be ascertained according to a particular study design is the primary purpose of the `SimRVPedigree` package and is accomplished with the `sim_RVpedigree` function.  


To simulate a pedigree with `sim_RVpedigree` the user must specify:

1. `onset_hazard`: the population age-specific disease onset hazard.
2. `death_hazard`: a data frame with:
     1. column 1: the unaffected age-specific death hazard,
     2. column 2: the affected age-specific death hazard.
   If the disease of interest is sufficiently rare, the user's discretion the unaffected age-specific death hazard my be approximated by the population age-specific death hazard. 
3. `part`: a partition of ages over which to apply the age-specific hazard in `onset_hazard` and `death_hazard`.
4. `RR`: the relative risk of diesase onset for indivdiuals who have inherited the rare variant. 
5. `FamID`: the family ID to assign to the simuated pedigree.
6. `founder_byears`: the span of years from which to simulate, uniformly, the founder's birth year.
7. `ascertain_span`: the ascertainment period in years.  This period represents the range of years during which the proband developed disease and the family would have been ascertained for multiple affecteds. 
8. `num_affected`: the minimum number of affected individuals in the pedigree. 

Optional arguments:

9. `recall_probs`: the proband's relative recall probabilities, if unspecified 4*kinship coeffient between the proband and the relative will be used.
10. `birth_range`: the minimum and maximum allowable ages indivduals will be able to reproduce.  If unspecified it is assumed that `birth_range = c(18, 45)`.
11. `NB_params`: the size and probability parameters of the negative binomial distribution used to model the number of children per household. If unspecifed it is assumed that `NB_params = c(2, 4/7)`.
12. `stop_year`: the last year of study.  If unspecified the current year will be used.

We will illustrate the usage and output of this function in the next section.

#Example Application to Family-Based Study <a name="Example"></a>
Suppose that from 2000 to 2015, a group of researchers collected data on 150 families that contain at least two, related individuals who are affected by a lymphoid cancer.  Researchers believe that affecteds within a family share a rare variant that increases disease susceptibility.  While they are not willing to adopt the assumption that the same rare variant is segregating in each family, they are willing to make the simplifying assumption that genetic cases share the same relative risk parameter across families.  They have reason to believe that for the families contained in their sample, the genetic cases are 5 times more likely to experience onset of lymphiod cancer.  

Researchers have not encoutered individuals who have refused family participation, and are fairly confident that families have been fully ascertained.  Upon inspecting the founders in their ascertained families, they see that most were born between 1900 and 1980.

Based on the description of the family-based study described above, and referring to the input requirements in the last section, to simulate famlies accoding to this study design with the `sim_RVpedigree` function, users will set:

1. `num_affected` = 2
2. `ascertain_span` = c(2000, 2015)
3. `stop_year` = 2015
4. `RR` = 5
5. `recall_probs` = c(1)
6. `founder_byears` = c(1900, 1980)

Additionally, the user will need to specify:

1. `onset_hazard` = baseline age-specific onset hazard for lymphiod cancer.
2. `death_hazard` = a dataframe with 2 columns:
   1. `death_hazard[,1]` = age-specific death hazard for individuals who have never experienced onset of lymphoid cancer.
   2. `death_hazard[,2]` = age-specific death hazard for individuals who have experienced onset of lymphoid cancer.
3. `part` = a partition of ages over which to apply the age-specific hazards in `onset_hazard` and `death_hazard`.

Fortunately, for the user studying lymphiod cancer the age-specific lymphoid cancer onset hazard, and age-specific death hazard for individuals affected by lyphoid cancer are provided in the `AgeSpecific_Hazards` dataset included in with the `SimRVPedigree` package.  What is not included in this dataset are the age-specific death hazards for individuals who have never experienced onset of lymphoid cancer.  The `AgeSpecific_Hazards` dataset does, however, include the baseline age-specific death hazard in the population, which we will use in place of the unaffected age-specific death hazard.  For more information on the `AgeSpecifc_Hazards` dataset type the command `help(AgeSpecific_Hazards)` into the `R` console.

After installing the `SimRVPedigree` package, load it by typing the command:
```{r}
library(SimRVPedigree)
```

Next, we load the age-specific hazards for this application as follows:
```{r}
#load example hazards 
data("AgeSpecific_Hazards")
colnames(AgeSpecific_Hazards)

#specify onset hazard and death hazard
my_onset_hazard <- AgeSpecific_Hazards[,1]
my_death_hazard <- AgeSpecific_Hazards[,c(2,3)]

#Specify age partition.  The AgeSpecific_Hazards dataset documentation
# indicates that the appropriate partition is specified by
age_part <- seq(0, 100, by = 1)
```

```{r, echo = FALSE, fig.width = 7, fig.height = 3.5}
par(mfrow = c(1, 2))
plot(x = seq(1, 100, by = 1),
     y = AgeSpecific_Hazards[,1],
     xlab = "age",
     ylab = "LC onset hazard", ylim = c(0, 0.002),
     col = "red3", lwd = 2, type = "s")
plot(x = seq(1, 100, by = 1),
     y = AgeSpecific_Hazards[,3],
     xlab = "age",
     ylab = "death hazard",
     col = "goldenrod2", ylim = c(0, 0.8),
     lwd = 2, type = "s")
lines(x = seq(1, 100, by = 1),
     y = AgeSpecific_Hazards[,2],
     col = "dodgerblue", lwd = 2, type = "s")
legend("topleft", title = "Death Hazard", legend = c("Population", "LC Affected"),
       col = c("dodgerblue", "goldenrod2"), lwd = 2)
par(mfrow = c(1, 1))
```

```{r}
#Simulate a random pedigree 
set.seed(1)
ex_RVped <- sim_RVpedigree(onset_hazard = my_onset_hazard,
                           death_hazard = my_death_hazard,
                           part = age_part,
                           num_affected = 2,
                           ascertain_span = c(1900, 2015),
                           RR = 5, stop_year = 2015,
                           recall_probs = c(1),
                           founder_byears = c(1900, 1910),
                           FamID = 1)
```

The `sim_RVpedigree` returns two data frames, the first is the ped file of the original pedigree prior to trimming.  The second is the ascertained pedigree, with proband selected and unrecalled relatives removed.  If a relative cannot be recalled by the proband, but they are required to plot the pedigree using the `kinship2` package, they are be readded to the pedigree, but their information will be censored, and they will be re-labelled as unavailable.  

Since we are interested in pedigrees ascertained for the previously described family-based study we will focus on the second item returned by `sim_RVpedigree`.

```{r}
#Second ped file returned by sim_RVpedigree:
head(ex_RVped[[2]])
```

We can plot pedigrees with the help of the `kinship2` package.  The following code illustrates how this is accomplished. 

```{r, results = FALSE, tidy = TRUE, echo = TRUE, message=FALSE}
#Pedigrees may be plotted usign the kinship2 package.  Assuming that this 
#package has been installed it is loaded by executing the command:
 library(kinship2)
```
```{r, fig.height=5, fig.width=7}
 #Define pedigree to use kinship2's plot function
 ex_RVpedigree <- pedigree(id = ex_RVped[[2]]$ID,
                           dadid = ex_RVped[[2]]$dad_id,
                           momid = ex_RVped[[2]]$mom_id,
                           sex = (ex_RVped[[2]]$gender + 1),
                           affected = cbind(Affected = ex_RVped[[2]]$affected,
                                            Proband = ex_RVped[[2]]$proband,
                                            RV_status = ex_RVped[[2]]$DA1 + 
                                                        ex_RVped[[2]]$DA2),
                         famid = ex_RVped[[2]]$FamID)['1']
 plot(ex_RVpedigree)
 pedigree.legend(ex_RVpedigree, location = "topleft",  radius = 0.25)
```


#Parallel Processing Example<a name="ParProcExample"></a>
It is importatant to note that the processing time required to simulate a sample of pedigrees ascertained for multiple affecteds is directly related to (1) the rarity of the disease, and (2) the arguments specified by the user.  In particular, we expect to see increases in the required computation time as: 

 1. as the relative risk, `RR`, specifed by the user approaches 1, particularly for rare diseases,
 2. as ascertainment period, `ascertain_span`, narrows,
 3. and as the proband's relative recall probabilities, `recall_probs`, become smaller.
 
Given the vast number of study designs that can be specified, it is likely that there are particular combinations of simulation settings that may also lead to an increase in processsing time.  For this reason, we HIGHLY recommend the use of parallel processing when simulating a large set of pedigrees ascertained for multiple affected members.  

The following parallel processing example uses the `doParallel` and `doRNG` packages to simulate the entire study sample of 150 pedigrees described in the application of the last section.

The following example was intended for Windows and slight modifications may be necessary for Unix-like systems.

```{r, eval = FALSE}
#SITATION FOR DOPARALLEL VIGNETTE?
#Note that: while parallel processsing may acheived using only the doParallel 
#package, to ensure that simulations are reproducible we must also incorporate 
#the doRNG package.

#assuming they have been installed the required packages are loaded using the 
#commands:
library(doParallel)
library(doRNG)

# Before we create our cluster, let's determine how many processors are 
#currently in use using the getDoParWorkers function.  Since we have not created
#a cluster yet, this function should return 1.
getDoParWorkers()

#The number of cores available for parallel processing will depend on the the 
#computer  being used.  To determine how many cores are available for parallel 
#processing on your computer, simply execute the following command:
detectCores()

#To run simulations in parallel we must create a cluster and then register the 
#cluster. The following code illustrates how to create and register a cluster 
#that will simulate pedigrees in parallel on 2 cores.      
cl <- makeCluster(2)       # create cluster
registerDoParallel(cl)     # register cluster

#Note that getDoParWorkers() should now return 2 instead of 1
getDoParWorkers()

#To avoid problems, after you are finished using the cluster, you will want to 
#stop it. This can be acheived by executing:   
on.exit(stopCluster(cl))
#which will stop the cluster when you end the R session, or by executing 
#stopCluster(cl) after the simulation is complete.

#to ensure reproducibility, we make use of the %dorng% operator provided by the 
#doRNG package, in the foreach loop, by specifing a seed after .option.RNG.  
npeds <- 150    #set the number of pedigrees to generate

RV_peds = foreach(i = seq(npeds),   
                  .combine = rbind,  
                  .packages = c("kinship2", "SimRVPedigree"),  
                  .options.RNG = 1984
                  ) %dorng% {
                    sim_RVpedigree(onset_hazard = my_onset_hazard,
                                   death_hazard = my_death_hazard,
                                   part = age_part,
                                   num_affected = 2,
                                   ascertain_span = c(1900, 2015),
                                   RR = 5, stop_year = 2015,
                                   recall_probs = c(1),
                                   founder_byears = c(1900, 1910),
                                   FamID = i)[[2]]
                    }
```
